
{{ $file := .Get "file" }}
{{ $language := .Get "language" }}
{{ $ghlink := .Get "ghlink" }}
{{/* TODO(bep) k8slink ? also ghlink https://raw.githubusercontent.com/kubernetes/kubernetes/blob/{{page.githubbranch}} */}}
{{ $fileDir := path.Split $file }}
{{ $bundlePath := path.Join .Page.Dir $fileDir.Dir }}
{{ $bundle := .Site.GetPage "page" $bundlePath | default .Page.CurrentSection }}
{{ with $bundle }}
{{ $resource := .Resources.GetMatch $fileDir.File }}
{{ with $resource }}{{ $.Scratch.Set "content" .Content }}{{ end }}
{{ if not $resource }}
{{/* Fall back to file reading. We should consider creating headless bundles of these. */}}
{{ $resource := readFile (path.Join $.Page.Dir $file) }}
{{ with $resource }}{{ $.Scratch.Set "content" . }}{{ end }}
{{ if not $resource}}
{{ errorf "resource name %q not found in %q" $fileDir.File $bundlePath }}
{{ end }}
{{ end }}
{{ with $.Scratch.Get "content" }}
<table class="includecode">
    <thead>
        <tr>
            <th>
                {{ with $ghlink }}<a href="{{ . }}" download="{{ $file }}">{{ end }}
                    <code>{{ $file }} {{ $bundlePath }}</code>
                {{ if $ghlink }}</a>{{ end }}
                <img src="{{ "images/copycode.svg" | relURL }}" style="max-height:24px" onclick="copyCode('{{ $file }}')" title="Copy {{ $file }} to clipboard">
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ highlight . $language "" }}  </td>
        </tr>
    </tbody>
</table>
{{ end }}
{{ end }}